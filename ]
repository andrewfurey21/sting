#include "../include/object.hpp"
#include <cstdlib>
#include <cstring>

namespace sting {

void string::allocate_size() {
    free(_data);
    _data = reinterpret_cast<u8*>(malloc(_size * sizeof(u8)));
}

string::string() : _data(nullptr), _size(0) {}

string::string(u64 size) : string() {
    _size = size;
    allocate_size();
}

string::string(const u8* other) : string() {
    _size = strlen(other);
    allocate_size();
    strcpy(_data, other); // TODO: rewrite strcpy
}

string::~string() {
    free(_data);
}

string::string(const string& other) : _size(other._size), _data(nullptr) {
    std::cout << "Copy constructor\n";
    free(_data);
    allocate_size();
    strcpy(_data, other.data());
}

string::string(string&& other) {
    std::cout << "Move constructor\n";
    _size = exchange(other._size, 0);
    _data = exchange(other._data, nullptr);
}

string& string::operator=(const string& other) {
    std::cout << "Copy assignment\n";
    if (this != &other) {
        free(_data);
        _size = other._size;
        allocate_size();
        strcpy(_data, other._data);
    }
    return *this;
}

string& string::operator=(string&& other) {
    std::cout << "Move assignment\n";
    if (this != &other) {
        _size = exchange(other._size, 0);
        _data = exchange(other._data, nullptr);
    }
    return *this;
}

char string::at(u64 index) const {
    panic_if(index >= _size, "string::at(): index out of bounds", -1);
    return _data[index];
}

string string::operator+(const string& other) {
    string concat(_size + other._size);
    strcpy(concat._data, _data);
    strcpy(concat._data + _size, other._data);
    return concat;
}

void string::operator+=(const string& other) {
    string concat(_size + other._size);
    strcpy(concat._data, _data);
    strcpy(concat._data + _size, other._data);

    _size = exchange(concat._size, _size);
    _data = exchange(concat._data, _data);
}

std::ostream& operator<<(std::ostream& os, const string& str) {
    for (u64 i{}; i < str._size; i++) {
        os << str.at(i);
    }
    return os;
}

};
